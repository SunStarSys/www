{% if permalink %}
<span class="badge bg-info" style="color:#000">Permalink</span>&nbsp;
{% endif %}

{% if archive_path %}
<span class="badge bg-warning">
  <a style="color:#000" href="{{archive_path}}">Archived</a></span>&nbsp;
{% endif %}

{% for k in headers.keywords %}
<span class="badge bg-danger" style="color:#000">
  <a style="color:#fff"
     href="/dynamic/search{{path|dirname}}/?regex=%23{{k}};lang={{lang}}">#{{k}}</a>
</span>&nbsp;
{% endfor %}

<p>
	&nbsp;
</p>

{% for c in headers.categories %}
<button type="button" class="btn btn-success">
  <a style="color:#fff" href="{{category_root|default_if_none:".."}}/{{c}}">{{c}}</a></button>
&nbsp;
{% endfor %}

<hr>
<div class="card border-warning">
  <form action="https://cms.sunstarsys.com/redirect" id="form" method="GET">
    <input type="hidden" id="action" name="action" value="comment">
    <input type="hidden" name="lang" value="{{lang|cut:"."}}">

    <div class="card-header">
      <h3 class="card-title">Comments &nbsp;
        <button type="submit" name="uri"
                value="https://{{website}}{{path|dirname}}/{{path|basename:0}}.page/comment.md{{lang}}"
                class="btn btn-sm btn-outline-warning">
              New
        </button>
      </h3>
    </div>

    <div id="comments" class="card-body">
      {% for c in comments %}
      {% if c.headers.closed %}
      {% else %}
      <article id="article-{{c.key}}" {% if c.closed %}class="text-muted"{% else %}{% endif %}>
        <header>
          <h4 class="card-title" id="{{c.key}}">
            &nbsp;
            <a href="#{{c.key}}-link" class="reference-link">{{c.headers.title}}</a>
            by {{c.content|ssi|vcs_author:lang}}
            on <em><time>{{c.content|ssi|vcs_date}}</time></em> &nbsp;
            <button type="submit" class="btn btn-sm btn-outline-warning" name="uri"
                    value="https://{{website}}{{path|dirname}}/{{path|basename:0}}.page/{{c.key}}.md{{lang}}">
              Reply
            </button>
<!--
            <button type="submit" class="btn btn-sm btn-outline-warning" name="uri"
                    value="https://{{website}}{{path|dirname}}/{{path|basename:0}}.page/{{c.key}}.md{{lang}}"
              onclick='$("#action").val("edit");false'>
              Close
            </button>
-->
          </h4>
        </header>
        <p class="card-text">{{c.content|markdown}}</p>
        <hr>
        <p>&nbsp;</p>
      </article>
      {% endif %}
      {% endfor %}
    </div>

  </form>
</div>

<script type="text/javascript">
  var html = "";
  var current_level = 0;
  var last_level = 0;
  for (const e of $("article").toArray()) {
      var id = e.getAttribute("id");
      current_level = (id.length - 15) / 2;
      if (current_level == last_level)
          html += "</li><li>" + e.outerHTML;
      else if (current_level > last_level)
          html += "<ul><li>" + e.outerHTML;
      else
          html += (new Array(last_level - current_level + 1)).join("</li></ul>") + "<li>" + e.outerHTML;
      last_level = current_level;
  }
  html += (new Array(last_level + 1)).join("</li></ul>");
  $("#comments").html(html);
</script>

{% filter markdown %}
{% if deps.0 %}
--------

## Index

{% for d in deps %}
- [{{d.1.headers.title|safe}}]({{d.0|urlencode}}) &mdash; {{d.1.content|ssi|lede}} ... <small><em>{{d.1.content|ssi|vcs_date}}</em></small>
{% endfor %}
{% endif %}
{% endfilter %}
